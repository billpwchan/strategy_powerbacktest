<!DOCTYPE html>
<html>
<head>
    <title>Multi-Symbol Backtest Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/modules/heatmap.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #2c3e50;
            padding: 2rem;
        }

        .strategy-overview {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .strategy-overview:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .strategy-overview::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(45deg);
            transition: opacity 0.3s ease;
        }

        .strategy-overview:hover::before {
            opacity: 0.2;
        }

        .strategy-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .strategy-description {
            font-size: 1rem;
            line-height: 1.5;
            opacity: 0.9;
        }

        .strategy-metrics {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .metric {
            text-align: center;
            flex: 1;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            margin: 0 0.5rem;
            transition: background 0.3s ease;
        }

        .metric:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .metric-title {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .overview-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .metric-card {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 1rem;
            backdrop-filter: blur(10px);
        }

        .metric-title {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .symbol-section {
            background: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .chart-container {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .correlation-matrix {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin: 3rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 500;
        }

        .badge-success {
            background-color: #2ecc71;
            color: white;
        }

        .badge-danger {
            background-color: #e74c3c;
            color: white;
        }

        .badge-buy {
            background-color: #2ecc71;
            color: white;
        }

        .badge-sell {
            background-color: #e74c3c;
            color: white;
        }

        .positive { color: #2ecc71; }
        .negative { color: #e74c3c; }

        table.dataTable {
            border-radius: 1rem;
            overflow: hidden;
        }

        .dataTables_wrapper .row {
            margin: 1rem 0;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-group {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .metric-group:hover {
            transform: translateY(-5px);
        }

        .metric-group h3 {
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .metric-group h3 i {
            margin-right: 0.5rem;
            opacity: 0.8;
        }

        .metric-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            background: #f8f9fa;
            transition: background-color 0.2s;
        }

        .metric-card:hover {
            background: #e9ecef;
        }

        .charts-grid {
            margin-top: 2rem;
        }

        .symbol-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .symbol-title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .symbol-metrics {
            margin-left: auto;
        }

        .trades-section {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .trades-section h3 {
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .trades-section h3 i {
            margin-right: 0.5rem;
            opacity: 0.8;
        }

        .badge-buy {
            background-color: #2ecc71;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 500;
        }

        .badge-sell {
            background-color: #e74c3c;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 500;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            border-bottom: 2px solid #e9ecef;
            font-weight: 600;
            color: #2c3e50;
        }

        .table td {
            vertical-align: middle;
        }

        .positive {
            color: #2ecc71;
            font-weight: 500;
        }

        .negative {
            color: #e74c3c;
            font-weight: 500;
        }

        /* DataTables customization */
        .dataTables_wrapper .dataTables_length select {
            border-radius: 0.5rem;
            padding: 0.375rem 1.75rem 0.375rem 0.75rem;
        }

        .dataTables_wrapper .dataTables_filter input {
            border-radius: 0.5rem;
            padding: 0.375rem 0.75rem;
        }

        .dataTables_wrapper .dataTables_info {
            color: #6c757d;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border-radius: 0.5rem;
            margin: 0 0.2rem;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #3498db;
            border-color: #3498db;
            color: white !important;
        }

        .trades-table {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .positive { 
            color: #00c853;
            font-weight: 600;
        }

        .negative { 
            color: #ff1744;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Strategy Overview Section -->
    <div class="strategy-overview" data-aos="fade-up">
        <div class="strategy-title">{{ strategy_name }} - Multi-Symbol Backtest Report</div>
        <div class="strategy-description">
            A brief description of the strategy goes here. Highlight the key aspects and objectives of the strategy.
        </div>
        <div class="strategy-metrics">
            {% for metric in overall_metrics %}
            <div class="metric">
                <div class="metric-title">{{ metric.title }}</div>
                <div class="metric-value {% if metric.color %}{{ metric.color }}{% endif %}">
                    {{ metric.value }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Correlation Matrix -->
    <div class="correlation-matrix">
        <h2>Symbol Correlation Matrix</h2>
        <div id="correlationMatrix" style="height: 400px;"></div>
    </div>

    <!-- Portfolio Performance -->
    <div class="chart-container">
        <h2>Portfolio Performance</h2>
        <div id="portfolioEquity" style="height: 400px;"></div>
    </div>

    <!-- Symbol-specific Sections -->
    {% for symbol, results in symbol_results.items() %}
    <div class="symbol-section" id="symbol-{{ symbol }}">
        <div class="symbol-header">
            <h2 class="symbol-title">{{ symbol }} Analysis</h2>
            <div class="symbol-metrics">
                <span class="badge {% if results.total_return >= 0 %}badge-success{% else %}badge-danger{% endif %}">
                    {{ "{:.2f}%".format(results.total_return * 100) }}
                </span>
            </div>
        </div>

        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <!-- Performance Metrics -->
            <div class="metric-group" data-aos="fade-up">
                <h3><i class="fas fa-chart-line"></i> Performance Metrics</h3>
                {% for metric in results.metrics['Performance Metrics'] %}
                <div class="metric-card">
                    <div class="metric-title">{{ metric.title }}</div>
                    <div class="metric-value {% if metric.color %}{{ metric.color }}{% endif %}">
                        {{ metric.value }}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Risk Metrics -->
            <div class="metric-group" data-aos="fade-up" data-aos-delay="100">
                <h3><i class="fas fa-shield-alt"></i> Risk Metrics</h3>
                {% for metric in results.metrics['Risk Metrics'] %}
                <div class="metric-card">
                    <div class="metric-title">{{ metric.title }}</div>
                    <div class="metric-value {% if metric.color %}{{ metric.color }}{% endif %}">
                        {{ metric.value }}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Trading Statistics -->
            <div class="metric-group" data-aos="fade-up" data-aos-delay="200">
                <h3><i class="fas fa-calculator"></i> Trading Statistics</h3>
                {% for metric in results.metrics['Trading Statistics'] %}
                <div class="metric-card">
                    <div class="metric-title">{{ metric.title }}</div>
                    <div class="metric-value {% if metric.color %}{{ metric.color }}{% endif %}">
                        {{ metric.value }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <div class="chart-container" data-aos="fade-up">
                <div id="equity-{{ symbol }}" style="height: 300px;"></div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container" data-aos="fade-up" data-aos-delay="100">
                        <div id="drawdown-{{ symbol }}" style="height: 250px;"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container" data-aos="fade-up" data-aos-delay="200">
                        <div id="monthly-returns-{{ symbol }}" style="height: 250px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade Analysis Section -->
        <div class="section mb-5">
            <h3><i class="fas fa-exchange-alt"></i>Trade History</h3>
            <!-- Price Chart with Trade Points -->
            <div class="chart-container">
                <div id="price-{{ symbol }}" style="height: 400px;"></div>
            </div>
            <!-- Trades Table -->
            <div class="trades-table">
                <div id="tradesGrid-{{ symbol }}" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>
            </div>
        </div>
    </div>
    {% endfor %}

    <script>
        // Initialize AG Grid for all symbol trade tables
        $(document).ready(function() {
            const gridOptions = {
                defaultColDef: {
                    sortable: true,
                    filter: true,
                    resizable: true,
                    minWidth: 100,
                },
                columnDefs: [
                    { 
                        field: 'timestamp',
                        headerName: 'Date',
                        sort: 'desc',
                        minWidth: 160
                    },
                    { 
                        field: 'type',
                        headerName: 'Type',
                        cellRenderer: params => {
                            const type = params.value.toUpperCase();
                            return `<span class="badge ${type === 'BUY' ? 'badge-buy' : 'badge-sell'}">${type}</span>`;
                        },
                        minWidth: 120,
                        filter: 'agSetColumnFilter'
                    },
                    { 
                        field: 'price',
                        headerName: 'Price',
                        valueFormatter: params => `$${params.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`,
                        type: 'numericColumn'
                    },
                    { 
                        field: 'quantity',
                        headerName: 'Quantity',
                        type: 'numericColumn'
                    },
                    { 
                        field: 'cost',
                        headerName: 'Cost',
                        valueFormatter: params => `$${params.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`,
                        type: 'numericColumn'
                    },
                    { 
                        field: 'commission',
                        headerName: 'Commission',
                        valueFormatter: params => `$${params.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`,
                        type: 'numericColumn'
                    },
                    { 
                        field: 'pnl',
                        headerName: 'P&L',
                        cellRenderer: params => {
                            const value = params.value;
                            const formatted = `$${Math.abs(value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                            return `<span class="${value >= 0 ? 'positive' : 'negative'}">${formatted}</span>`;
                        },
                        type: 'numericColumn'
                    }
                ],
                pagination: true,
                paginationPageSize: 25,
                rowHeight: 48,
                headerHeight: 48,
                animateRows: true,
                enableCellTextSelection: true,
                suppressDragLeaveHidesColumns: true,
                rowClass: 'trade-row'
            };

            // Add custom CSS for AG Grid styling
            const style = document.createElement('style');
            style.textContent = `
                .ag-theme-alpine {
                    --ag-font-family: 'Inter', sans-serif;
                    --ag-font-size: 14px;
                    --ag-header-background-color: #f8f9fa;
                    --ag-odd-row-background-color: #ffffff;
                    --ag-row-hover-color: #f8f9fa;
                    --ag-selected-row-background-color: #e9ecef;
                    --ag-header-column-separator-display: none;
                    --ag-borders: none;
                }
                
                .trade-row {
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .ag-header-cell {
                    font-weight: 600;
                }
            `;
            document.head.appendChild(style);

            // Initialize grids for each symbol
            {% for symbol in symbol_results.keys() %}
                const gridDiv = document.querySelector(`#tradesGrid-{{ symbol }}`);
                const gridInstance = new agGrid.Grid(gridDiv, gridOptions);
                gridInstance.gridOptions.api.setRowData({{ symbol_results[symbol].trades|tojson }});
            {% endfor %}
        });

        // Enhanced Highcharts theme
        Highcharts.setOptions({
            chart: {
                style: {
                    fontFamily: 'Inter, sans-serif'
                }
            }
        });

        // Combined Portfolio Equity Curve
        Highcharts.stockChart('portfolioEquity', {
            chart: { 
                type: 'area',
                style: { fontFamily: 'Inter, sans-serif' }
            },
            title: { text: 'Combined Portfolio Performance' },
            xAxis: { type: 'datetime' },
            yAxis: { 
                title: { text: 'Portfolio Value ($)' },
                labels: { formatter: function() { return '$' + this.value.toLocaleString(); } }
            },
            series: [{
                name: 'Portfolio Value',
                data: {{ portfolio_equity_data|tojson }},
                color: '#2c3e50',
                fillColor: {
                    linearGradient: {
                        x1: 0, y1: 0, x2: 0, y2: 1
                    },
                    stops: [
                        [0, Highcharts.color('#2c3e50').setOpacity(0.3).get('rgba')],
                        [1, Highcharts.color('#2c3e50').setOpacity(0).get('rgba')]
                    ]
                }
            }],
            tooltip: {
                valuePrefix: '$',
                valueDecimals: 2
            }
        });

        // Correlation Matrix Heatmap
        Highcharts.chart('correlationMatrix', {
            chart: {
                type: 'heatmap',
                marginTop: 40,
                marginBottom: 80,
                plotBorderWidth: 1
            },
            title: {
                text: 'Symbol Correlation Matrix'
            },
            xAxis: {
                categories: {{ correlation_symbols|tojson }},
                labels: {
                    style: {
                        fontSize: '12px'
                    }
                }
            },
            yAxis: {
                categories: {{ correlation_symbols|tojson }},
                title: null,
                labels: {
                    style: {
                        fontSize: '12px'
                    }
                }
            },
            colorAxis: {
                min: -1,
                max: 1,
                stops: [
                    [0, '#ff5f5f'],     // Red for negative correlation
                    [0.5, '#ffffff'],   // White for no correlation
                    [1, '#50B432']      // Green for positive correlation
                ]
            },
            legend: {
                align: 'right',
                layout: 'vertical',
                margin: 0,
                verticalAlign: 'top',
                y: 25,
                symbolHeight: 280
            },
            series: [{
                name: 'Correlation',
                data: {{ correlation_data|tojson }},
                dataLabels: {
                    enabled: true,
                    color: '#000000',
                    style: {
                        fontSize: '11px'
                    },
                    format: '{point.value:.2f}'
                }
            }]
        });

        // Individual Symbol Charts
        {% for symbol, results in symbol_results.items() %}
            // Equity Curve
            Highcharts.chart('equity-{{ symbol }}', {
                chart: { type: 'area' },
                title: { text: '{{ symbol }} Equity Curve' },
                xAxis: { type: 'datetime' },
                yAxis: { 
                    title: { text: 'Value ($)' },
                    labels: { formatter: function() { return '$' + this.value.toLocaleString(); } }
                },
                series: [{
                    name: 'Equity',
                    data: {{ results.equity_curve|tojson }},
                    color: '#3498db',
                    fillColor: {
                        linearGradient: {
                            x1: 0, y1: 0, x2: 0, y2: 1
                        },
                        stops: [
                            [0, Highcharts.color('#3498db').setOpacity(0.3).get('rgba')],
                            [1, Highcharts.color('#3498db').setOpacity(0).get('rgba')]
                        ]
                    }
                }],
                tooltip: {
                    valuePrefix: '$',
                    valueDecimals: 2
                }
            });

            // Drawdown Chart
            Highcharts.chart('drawdown-{{ symbol }}', {
                chart: { type: 'area' },
                title: { text: '{{ symbol }} Drawdown' },
                xAxis: { type: 'datetime' },
                yAxis: {
                    title: { text: 'Drawdown (%)' },
                    labels: { format: '{value}%' }
                },
                series: [{
                    name: 'Drawdown',
                    data: {{ results.drawdown|tojson }},
                    color: '#e74c3c',
                    fillColor: {
                        linearGradient: {
                            x1: 0, y1: 0, x2: 0, y2: 1
                        },
                        stops: [
                            [0, Highcharts.color('#e74c3c').setOpacity(0.3).get('rgba')],
                            [1, Highcharts.color('#e74c3c').setOpacity(0).get('rgba')]
                        ]
                    }
                }],
                tooltip: {
                    valueSuffix: '%',
                    valueDecimals: 2
                }
            });

            // Monthly Returns
            Highcharts.chart('monthly-returns-{{ symbol }}', {
                chart: { type: 'column' },
                title: { text: '{{ symbol }} Monthly Returns' },
                xAxis: { type: 'datetime' },
                yAxis: {
                    title: { text: 'Return (%)' },
                    labels: { format: '{value}%' }
                },
                series: [{
                    name: 'Monthly Return',
                    data: {{ results.monthly_returns|tojson }},
                    color: '#2ecc71',
                    negativeColor: '#e74c3c'
                }],
                tooltip: {
                    valueSuffix: '%',
                    valueDecimals: 2
                }
            });

            // Price Chart with Trade Points
            Highcharts.stockChart('price-{{ symbol }}', {
                chart: { 
                    type: 'line',
                    style: { fontFamily: 'Inter, sans-serif' }
                },
                title: { text: '{{ symbol }} Price Chart with Trades' },
                yAxis: { 
                    title: { text: 'Price ($)' },
                    labels: { formatter: function() { return '$' + this.value.toLocaleString(); } }
                },
                series: [{
                    name: 'Price',
                    data: {{ results.price_data|tojson }},
                    color: '#2c3e50',
                    lineWidth: 2,
                    id: 'price'
                }, {
                    type: 'scatter',
                    name: 'Trade Points',
                    data: {{ results.trade_annotations|tojson|safe }}.map(function(point) {
                        return {
                            x: point.x,
                            y: point.y,
                            marker: {
                                symbol: point.title === '↑' ? 'triangle' : 'triangle-down',
                                fillColor: point.title === '↑' ? '#00c853' : '#ff1744',
                                lineColor: point.title === '↑' ? '#00c853' : '#ff1744',
                                lineWidth: 1,
                                radius: 8
                            },
                            tooltip: {
                                pointFormat: point.text
                            }
                        };
                    }),
                    tooltip: {
                        pointFormat: '{point.tooltip}'
                    }
                }],
                tooltip: {
                    shared: true,
                    split: false,
                    valuePrefix: '$',
                    valueDecimals: 2
                },
                rangeSelector: {
                    enabled: true,
                    buttons: [{
                        type: 'day',
                        count: 7,
                        text: '1w'
                    }, {
                        type: 'month',
                        count: 1,
                        text: '1m'
                    }, {
                        type: 'month',
                        count: 3,
                        text: '3m'
                    }, {
                        type: 'month',
                        count: 6,
                        text: '6m'
                    }, {
                        type: 'year',
                        count: 1,
                        text: '1y'
                    }, {
                        type: 'all',
                        text: 'All'
                    }],
                    selected: 4
                },
                navigator: {
                    enabled: true
                }
            });
        {% endfor %}

        // Initialize AOS
        AOS.init({
            duration: 800,
            once: true,
            offset: 100
        });
    </script>
</body>
</html> 
</html> 