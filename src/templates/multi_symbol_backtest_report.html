<!DOCTYPE html>
<html>
<head>
    <title>Multi-Symbol Backtest Report</title>
    <!-- Core Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/modules/heatmap.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <!-- Styling -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">

    <!-- AG Grid -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css">

    <!-- Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #2c3e50;
            padding: 2rem;
        }

        .strategy-overview {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .strategy-overview:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .strategy-overview::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(45deg);
            transition: opacity 0.3s ease;
        }

        .strategy-overview:hover::before {
            opacity: 0.2;
        }

        .strategy-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .strategy-description {
            font-size: 1rem;
            line-height: 1.5;
            opacity: 0.9;
        }

        .strategy-metrics {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .metric {
            text-align: center;
            flex: 1;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            margin: 0 0.5rem;
            transition: background 0.3s ease;
        }

        .metric:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .metric-title {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .overview-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .metric-card {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 1rem;
            backdrop-filter: blur(10px);
        }

        .metric-title {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .symbol-section {
            background: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .chart-container {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .correlation-matrix {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        #correlationMatrix {
            min-height: 400px;
            margin: 1rem 0;
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 500;
        }

        .badge-success {
            background-color: #2ecc71;
            color: white;
        }

        .badge-danger {
            background-color: #e74c3c;
            color: white;
        }

        .badge-buy {
            background-color: #2ecc71;
            color: white;
        }

        .badge-sell {
            background-color: #e74c3c;
            color: white;
        }

        .positive { color: #2ecc71; }
        .negative { color: #e74c3c; }

        table.dataTable {
            border-radius: 1rem;
            overflow: hidden;
        }

        .dataTables_wrapper .row {
            margin: 1rem 0;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-group {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .metric-group:hover {
            transform: translateY(-5px);
        }

        .metric-group h3 {
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .metric-group h3 i {
            margin-right: 0.5rem;
            opacity: 0.8;
        }

        .metric-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            background: #f8f9fa;
            transition: background-color 0.2s;
        }

        .metric-card:hover {
            background: #e9ecef;
        }

        .charts-grid {
            margin-top: 2rem;
        }

        .symbol-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .symbol-title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .symbol-metrics {
            margin-left: auto;
        }

        .trades-section {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .trades-section h3 {
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .trades-section h3 i {
            margin-right: 0.5rem;
            opacity: 0.8;
        }

        .badge-buy {
            background-color: #2ecc71;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 500;
        }

        .badge-sell {
            background-color: #e74c3c;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 500;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            border-bottom: 2px solid #e9ecef;
            font-weight: 600;
            color: #2c3e50;
        }

        .table td {
            vertical-align: middle;
        }

        .positive {
            color: #2ecc71;
            font-weight: 500;
        }

        .negative {
            color: #e74c3c;
            font-weight: 500;
        }

        /* DataTables customization */
        .dataTables_wrapper .dataTables_length select {
            border-radius: 0.5rem;
            padding: 0.375rem 1.75rem 0.375rem 0.75rem;
        }

        .dataTables_wrapper .dataTables_filter input {
            border-radius: 0.5rem;
            padding: 0.375rem 0.75rem;
        }

        .dataTables_wrapper .dataTables_info {
            color: #6c757d;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border-radius: 0.5rem;
            margin: 0 0.2rem;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #3498db;
            border-color: #3498db;
            color: white !important;
        }

        .trades-table {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .positive { 
            color: #00c853;
            font-weight: 600;
        }

        .negative { 
            color: #ff1744;
            font-weight: 600;
        }

        .metrics-dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card-large {
            grid-column: 1 / -1;
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .metric-card-medium {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .metric-header {
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e9ecef;
        }

        .metric-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .metric-header h3 i {
            margin-right: 0.5rem;
            opacity: 0.8;
        }

        .performance-highlights {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .highlight-stats {
            display: grid;
            gap: 1rem;
        }

        .stat-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 0.75rem;
            transition: transform 0.2s;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            background: #e9ecef;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .trading-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .stat-box {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 0.75rem;
            transition: all 0.2s;
        }

        .stat-box:hover {
            transform: translateY(-2px);
            background: #e9ecef;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 50%;
            margin-right: 1rem;
        }

        .stat-icon i {
            font-size: 1.25rem;
            color: #3498db;
        }

        .risk-details {
            margin-top: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0.75rem;
            transition: transform 0.2s;
        }

        .detail-item:hover {
            transform: translateY(-2px);
            background: #e9ecef;
        }

        .detail-label {
            display: block;
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .detail-value {
            display: block;
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* Adjust radar chart container */
        #riskRadar-{{ symbol }} {
            height: 300px;
            margin: 0 auto;
        }

        /* Risk metrics card specific adjustments */
        .metric-card-medium .metric-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .correlation-matrix {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        #correlationMatrix {
            min-height: 400px;
            margin: 1rem 0;
        }

        .page-pretitle {
            font-size: 0.825rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #656d77;
            margin-bottom: 0.25rem;
        }
        
        .page-title {
            margin: 0;
            font-size: 1.65rem;
            line-height: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            word-break: break-word;
        }

        .card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .metric-overview {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .metric-overview:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }

        .metric-icon i {
            font-size: 1.2rem;
            color: #3498db;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .card-header {
            padding: 1.25rem;
            border-bottom: 1px solid #e9ecef;
            background: white;
        }

        .card-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-container {
            padding: 1.5rem;
            height: 400px;
        }

        @media (max-width: 992px) {
            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Page header -->
        <div class="page-header d-print-none">
            <div class="container-xl">
                <div class="row g-2 align-items-center">
                    <div class="col">
                        <div class="page-pretitle">
                            Backtest Results
                        </div>
                        <h2 class="page-title">
                            {{ strategy_name }} - Multi-Symbol Analysis
                        </h2>
                    </div>
                    <!-- Page title actions -->
                    <div class="col-auto ms-auto d-print-none">
                        <div class="btn-list">
                            <span class="d-none d-sm-inline">
                                <a href="#" class="btn btn-white" onclick="window.print()">
                                    <i class="ti ti-printer"></i>
                                    Export PDF
                                </a>
                            </span>
                            <a href="#" class="btn btn-primary d-none d-sm-inline-block" data-bs-toggle="modal" data-bs-target="#modal-report">
                                <i class="ti ti-chart-bar"></i>
                                View Full Report
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Page body -->
        <div class="page-body">
            <div class="container-xl">
                <!-- Overview Cards -->
                <div class="row g-3 mb-4">
                    {% for metric in overall_metrics %}
                    <div class="col-sm-6 col-lg-3">
                        <div class="card metric-overview">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="metric-icon">
                                        <i class="fas fa-{{ 'chart-line' if 'return' in metric.title.lower() 
                                                        else 'chart-bar' if 'sharpe' in metric.title.lower() 
                                                        else 'chart-area' }}"></i>
                                    </div>
                                    <div class="subheader">{{ metric.title }}</div>
                                </div>
                                <div class="h1 mb-3 {% if metric.color %}{{ metric.color }}{% endif %}">
                                    {{ metric.value }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Main Analysis Grid -->
                <div class="analysis-grid">
                    <!-- Portfolio Performance -->
                    <div class="chart-card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-line"></i> Portfolio Performance</h3>
                        </div>
                        <div id="portfolioEquity" class="chart-container"></div>
                    </div>

                    <!-- Correlation Matrix -->
                    <div class="chart-card">
                        <div class="card-header">
                            <h3><i class="fas fa-project-diagram"></i> Symbol Correlation Matrix</h3>
                        </div>
                        <div id="correlationMatrix" class="chart-container"></div>
                    </div>
                </div>

                <!-- Symbol-specific Sections -->
                {% for symbol, results in symbol_results.items() %}
                <div class="symbol-section" id="symbol-{{ symbol }}">
                    <div class="symbol-header">
                        <h2 class="symbol-title">{{ symbol }} Analysis</h2>
                        <div class="symbol-metrics">
                            <span class="badge {% if results.total_return >= 0 %}badge-success{% else %}badge-danger{% endif %}">
                                {{ "{:.2f}%".format(results.total_return * 100) }}
                            </span>
                        </div>
                    </div>

                    <!-- Metrics Dashboard -->
                    <div class="metrics-dashboard">
                        <!-- Performance Overview -->
                        <div class="metric-card-large" data-aos="fade-up">
                            <div class="metric-header">
                                <h3><i class="fas fa-chart-line"></i> Performance Overview</h3>
                            </div>
                            <div class="metric-content">
                                <div class="trading-stats-grid">
                                    {% for metric in results.metrics['Performance Metrics'] %}
                                    <div class="stat-box">
                                        <div class="stat-icon">
                                            <i class="fas fa-{{ 'arrow-trend-up' if 'return' in metric.title.lower() else 'chart-line' if 'alpha' in metric.title.lower() or 'beta' in metric.title.lower() else 'calculator' }}"></i>
                                        </div>
                                        <div class="stat-info">
                                            <div class="stat-label">{{ metric.title }}</div>
                                            <div class="stat-value {% if metric.color %}{{ metric.color }}{% endif %}">
                                                {{ metric.value }}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Risk Analysis -->
                        <div class="metric-card-medium" data-aos="fade-up" data-aos-delay="100">
                            <div class="metric-header">
                                <h3><i class="fas fa-shield-alt"></i> Risk Analysis</h3>
                            </div>
                            <div class="metric-content">
                                <div class="trading-stats-grid">
                                    {% for metric in results.metrics['Risk Metrics'] %}
                                    <div class="stat-box">
                                        <div class="stat-icon">
                                            <i class="fas fa-{{ 'chart-area' if 'drawdown' in metric.title.lower() else 'chart-line' if 'volatility' in metric.title.lower() else 'shield' }}"></i>
                                        </div>
                                        <div class="stat-info">
                                            <div class="stat-label">{{ metric.title }}</div>
                                            <div class="stat-value {% if metric.color %}{{ metric.color }}{% endif %}">
                                                {{ metric.value }}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Trading Statistics -->
                        <div class="metric-card-medium" data-aos="fade-up" data-aos-delay="200">
                            <div class="metric-header">
                                <h3><i class="fas fa-calculator"></i> Trading Statistics</h3>
                            </div>
                            <div class="metric-content">
                                <div class="trading-stats-grid">
                                    {% for metric in results.metrics['Trading Statistics'] %}
                                    <div class="stat-box">
                                        <div class="stat-icon">
                                            <i class="fas fa-{{ 'arrow-up' if 'win' in metric.title.lower() else 'arrow-down' if 'loss' in metric.title.lower() else 'chart-bar' }}"></i>
                                        </div>
                                        <div class="stat-info">
                                            <div class="stat-label">{{ metric.title }}</div>
                                            <div class="stat-value {% if metric.color %}{{ metric.color }}{% endif %}">
                                                {{ metric.value }}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="charts-grid">
                        <div class="chart-container" data-aos="fade-up">
                            <div id="equity-{{ symbol|replace('.', '-') }}" style="height: 400px;"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="chart-container" data-aos="fade-up" data-aos-delay="100">
                                    <div id="drawdown-{{ symbol|replace('.', '-') }}" style="height: 300px;"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="chart-container" data-aos="fade-up" data-aos-delay="200">
                                    <div id="monthly-returns-{{ symbol|replace('.', '-') }}" style="height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trade Analysis Section -->
                    <div class="section mb-5">
                        <h3><i class="fas fa-exchange-alt"></i>Trade History</h3>
                        <!-- Price Chart with Trade Points -->
                        <div class="chart-container">
                            <div id="price-{{ symbol|replace('.', '-') }}" style="height: 400px;"></div>
                        </div>
                        <!-- Trades Table -->
                        <div class="trades-table">
                            <div id="tradesGrid-{{ symbol|replace('.', '-') }}" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        // Helper function to sanitize symbol ID for CSS selector
        function sanitizeSymbolId(symbol) {
            return symbol.replace(/[.]/g, '-');
        }

        // Enhanced Highcharts theme
        Highcharts.setOptions({
            chart: {
                style: {
                    fontFamily: 'Inter, sans-serif'
                }
            },
            accessibility: {
                enabled: true,
                description: 'Trading backtest results visualization showing performance metrics and trade history.',
                announceNewData: {
                    enabled: true
                }
            }
        });

        // Combined Portfolio Equity Curve
        Highcharts.stockChart('portfolioEquity', {
            chart: { 
                type: 'area',
                style: { fontFamily: 'Inter, sans-serif' }
            },
            title: { text: 'Combined Portfolio Performance' },
            xAxis: { type: 'datetime' },
            yAxis: { 
                title: { text: 'Portfolio Value ($)' },
                labels: { formatter: function() { return '$' + this.value.toLocaleString(); } }
            },
            series: [{
                name: 'Portfolio Value',
                data: {{ portfolio_equity_data|tojson }},
                color: '#2c3e50',
                fillColor: {
                    linearGradient: {
                        x1: 0, y1: 0, x2: 0, y2: 1
                    },
                    stops: [
                        [0, Highcharts.color('#2c3e50').setOpacity(0.3).get('rgba')],
                        [1, Highcharts.color('#2c3e50').setOpacity(0).get('rgba')]
                    ]
                }
            }],
            tooltip: {
                valuePrefix: '$',
                valueDecimals: 2
            }
        });

        // Initialize correlation matrix
        $(document).ready(function() {
            Highcharts.chart('correlationMatrix', {
                chart: {
                    type: 'heatmap',
                    height: 400
                },
                title: { text: null },
                xAxis: {
                    categories: {{ correlation_symbols|tojson }},
                    labels: { rotation: -45 }
                },
                yAxis: {
                    categories: {{ correlation_symbols|tojson }},
                    title: null
                },
                colorAxis: {
                    min: -1,
                    max: 1,
                    stops: [
                        [0, '#ff1744'],    // Red for negative correlation
                        [0.5, '#f8f9fa'],  // Light gray for no correlation
                        [1, '#00c853']     // Green for positive correlation
                    ]
                },
                series: [{
                    name: 'Correlation',
                    data: {{ correlation_data|tojson }},
                    dataLabels: {
                        enabled: true,
                        color: '#2c3e50',
                        format: '{point.value:.2f}'
                    }
                }]
            });

            // Initialize symbol-specific charts
            {% for symbol, results in symbol_results.items() %}
                // Equity Curve
                Highcharts.chart('equity-{{ symbol|replace('.', '-') }}', {
                    chart: { type: 'area' },
                    title: { text: '{{ symbol }} Equity Curve' },
                    xAxis: { type: 'datetime' },
                    yAxis: { 
                        title: { text: 'Value ($)' },
                        labels: { formatter: function() { return '$' + this.value.toLocaleString(); } }
                    },
                    series: [{
                        name: 'Equity',
                        data: {{ results.equity_curve|tojson }},
                        color: '#3498db',
                        fillColor: {
                            linearGradient: {
                                x1: 0, y1: 0, x2: 0, y2: 1
                            },
                            stops: [
                                [0, Highcharts.color('#3498db').setOpacity(0.3).get('rgba')],
                                [1, Highcharts.color('#3498db').setOpacity(0).get('rgba')]
                            ]
                        }
                    }],
                    tooltip: {
                        valuePrefix: '$',
                        valueDecimals: 2
                    }
                });


                // Drawdown Chart
                Highcharts.chart('drawdown-{{ symbol|replace('.', '-') }}', {
                    chart: { type: 'area' },
                    title: { text: '{{ symbol }} Drawdown' },
                    xAxis: { type: 'datetime' },
                    yAxis: {
                        title: { text: 'Drawdown (%)' },
                        labels: { format: '{value}%' }
                    },
                    series: [{
                        name: 'Drawdown',
                        data: {{ results.drawdown|tojson }},
                        color: '#e74c3c',
                        fillColor: {
                            linearGradient: {
                                x1: 0, y1: 0, x2: 0, y2: 1
                            },
                            stops: [
                                [0, Highcharts.color('#e74c3c').setOpacity(0.3).get('rgba')],
                                [1, Highcharts.color('#e74c3c').setOpacity(0).get('rgba')]
                            ]
                        }
                    }],
                    tooltip: {
                        valueSuffix: '%',
                        valueDecimals: 2
                    }
                });

                // Monthly Returns
                Highcharts.chart('monthly-returns-{{ symbol|replace('.', '-') }}', {
                    chart: { type: 'column' },
                    title: { text: '{{ symbol }} Monthly Returns' },
                    xAxis: { type: 'datetime' },
                    yAxis: {
                        title: { text: 'Return (%)' },
                        labels: { format: '{value}%' }
                    },
                    series: [{
                        name: 'Monthly Return',
                        data: {{ results.monthly_returns|tojson }},
                        color: '#2ecc71',
                        negativeColor: '#e74c3c'
                    }],
                    tooltip: {
                        valueSuffix: '%',
                        valueDecimals: 2
                    }
                });


                // Price Chart with Trade Points
                Highcharts.stockChart('price-{{ symbol|replace('.', '-') }}', {
                    chart: { 
                        type: 'line',
                        style: { fontFamily: 'Inter, sans-serif' }
                    },
                    title: { text: '{{ symbol }} Price Chart with Trades' },
                    yAxis: { 
                        title: { text: 'Price ($)' },
                        labels: { formatter: function() { return '$' + this.value.toLocaleString(); } }
                    },
                    series: [{
                        name: 'Price',
                        data: {{ results.price_data|tojson }},
                        color: '#2c3e50',
                        lineWidth: 2,
                        id: 'price'
                    }, {
                        type: 'scatter',
                        name: 'Trade Points',
                        data: {{ results.trade_annotations|tojson|safe }}.map(function(point) {
                            return {
                                x: point.x,
                                y: point.y,
                                marker: {
                                    symbol: point.title === '↑' ? 'triangle' : 'triangle-down',
                                    fillColor: point.title === '↑' ? '#00c853' : '#ff1744',
                                    lineColor: point.title === '↑' ? '#00c853' : '#ff1744',
                                    lineWidth: 1,
                                    radius: 8
                                },
                                tooltip: {
                                    pointFormat: point.text
                                }
                            };
                        }),
                        tooltip: {
                            pointFormat: '{point.tooltip}'
                        }
                    }],
                    tooltip: {
                        shared: true,
                        split: false,
                        valuePrefix: '$',
                        valueDecimals: 2
                    },
                    rangeSelector: {
                        enabled: true,
                        buttons: [{
                            type: 'day',
                            count: 7,
                            text: '1w'
                        }, {
                            type: 'month',
                            count: 1,
                            text: '1m'
                        }, {
                            type: 'month',
                            count: 3,
                            text: '3m'
                        }, {
                            type: 'month',
                            count: 6,
                            text: '6m'
                        }, {
                            type: 'year',
                            count: 1,
                            text: '1y'
                        }, {
                            type: 'all',
                            text: 'All'
                        }],
                        selected: 4
                    },
                    navigator: {
                        enabled: true
                    }
                });

                // Initialize Trades Grid
                try {
                    const symbolId = sanitizeSymbolId('{{ symbol }}');
                    console.log('Initializing grid for symbol:', symbolId);
                    
                    const gridOptions = {
                        columnDefs: [
                            { 
                                field: 'timestamp', 
                                headerName: 'Date/Time', 
                                sort: 'desc',
                                sortable: true,
                                filter: true 
                            },
                            { 
                                field: 'type', 
                                headerName: 'Type',
                                cellRenderer: params => {
                                    return `<span class="${params.value.toLowerCase() === 'buy' ? 'positive' : 'negative'}">${params.value}</span>`;
                                }
                            },
                            { 
                                field: 'price', 
                                headerName: 'Price', 
                                valueFormatter: params => '$' + params.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})
                            },
                            { field: 'quantity', headerName: 'Quantity' },
                            { 
                                field: 'cost', 
                                headerName: 'Cost', 
                                valueFormatter: params => '$' + Math.abs(params.value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})
                            },
                            { 
                                field: 'commission', 
                                headerName: 'Commission', 
                                valueFormatter: params => '$' + params.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})
                            },
                            { 
                                field: 'pnl', 
                                headerName: 'P&L',
                                cellRenderer: params => {
                                    const value = params.value;
                                    const formattedValue = '$' + value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                    return `<span class="${value >= 0 ? 'positive' : 'negative'}">${formattedValue}</span>`;
                                }
                            }
                        ],
                        rowData: {{ results.trades|tojson|safe }},
                        defaultColDef: {
                            sortable: true,
                            filter: true,
                            resizable: true,
                            flex: 1
                        },
                        domLayout: 'autoHeight',
                        animateRows: true,
                        enableCellTextSelection: true,
                        pagination: true,
                        paginationPageSize: 10
                    };

                    const gridDiv = document.querySelector(`#tradesGrid-${symbolId}`);
                    if (!gridDiv) {
                        console.error('Grid container not found:', `#tradesGrid-${symbolId}`);
                        return;
                    }
                    
                    const gridApi = agGrid.createGrid(gridDiv, gridOptions);
                } catch (error) {
                    console.error('Error initializing grid:', error);
                }
            {% endfor %}
        });

        // Initialize AOS
        AOS.init({
            duration: 800,
            once: true,
            offset: 100
        });
    </script>
</body>
</html> 